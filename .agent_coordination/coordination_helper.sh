#!/bin/bash

# Agent Coordination Helper Script with JSON format (consistent with AgentCoordinationMiddleware)
# Provides utilities for managing agent coordination using nanosecond IDs

# Allow override for testing
COORDINATION_DIR="${COORDINATION_DIR:-/Users/sac/dev/ai-self-sustaining-system/.agent_coordination}"
WORK_CLAIMS_FILE="work_claims.json"
AGENT_STATUS_FILE="agent_status.json"
COORDINATION_LOG_FILE="coordination_log.json"

# Generate unique nanosecond-based agent ID
generate_agent_id() {
    echo "agent_$(date +%s%N)"
}

# Function to claim work atomically using JSON (consistent with AgentCoordinationMiddleware)
claim_work() {
    local work_type="$1"
    local description="$2"
    local priority="${3:-medium}"
    local team="${4:-autonomous_team}"
    
    # Generate unique nanosecond-based IDs
    local agent_id="${AGENT_ID:-$(generate_agent_id)}"
    local work_item_id
    work_item_id="work_$(date +%s%N)"
    
    echo "ü§ñ Agent $agent_id claiming work: $work_item_id"
    
    # Ensure coordination directory exists
    mkdir -p "$COORDINATION_DIR"
    
    # Create JSON claim structure (matching AgentCoordinationMiddleware format)
    local claim_json
    claim_json=$(cat <<EOF
{
  "work_item_id": "$work_item_id",
  "agent_id": "$agent_id",
  "reactor_id": "shell_agent",
  "claimed_at": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
  "estimated_duration": "30m",
  "work_type": "$work_type",
  "priority": "$priority",
  "description": "$description",
  "status": "active",
  "team": "$team"
}
EOF
    )
    
    local work_claims_path="$COORDINATION_DIR/$WORK_CLAIMS_FILE"
    local lock_file="$work_claims_path.lock"
    
    # Atomic claim using file locking (consistent with middleware)
    if (set -C; echo $$ > "$lock_file") 2>/dev/null; then
        # Lock acquired successfully
        trap 'rm -f "$lock_file"' EXIT
        
        # Initialize claims file if it doesn't exist
        if [ ! -f "$work_claims_path" ]; then
            echo "[]" > "$work_claims_path"
        fi
        
        # Check if work item already exists
        if jq -e --arg id "$work_item_id" '.[] | select(.work_item_id == $id and .status == "active")' "$work_claims_path" >/dev/null 2>&1; then
            echo "‚ö†Ô∏è CONFLICT: Work item $work_item_id already exists"
            rm -f "$lock_file"
            return 1
        fi
        
        # Add new claim to JSON array
        if command -v jq >/dev/null 2>&1; then
            jq --argjson claim "$claim_json" '. += [$claim]' "$work_claims_path" > "$work_claims_path.tmp" && \
            mv "$work_claims_path.tmp" "$work_claims_path"
        else
            # Fallback without jq - simple append (less robust but works)
            local temp_file
            temp_file=$(mktemp)
            head -n -1 "$work_claims_path" > "$temp_file"
            echo "  $claim_json," >> "$temp_file"
            echo "]" >> "$temp_file"
            mv "$temp_file" "$work_claims_path"
        fi
        
        echo "‚úÖ SUCCESS: Claimed work item $work_item_id for team $team"
        export CURRENT_WORK_ITEM="$work_item_id"
        export AGENT_ID="$agent_id"
        
        # Register agent in coordination system
        register_agent_in_team "$agent_id" "$team"
        
        rm -f "$lock_file"
        return 0
    else
        echo "‚ö†Ô∏è CONFLICT: Another process is updating work claims"
        return 1
    fi
}

# Register agent in coordination system using JSON
register_agent_in_team() {
    local agent_id="$1"
    local team="${2:-autonomous_team}"
    local capacity="${3:-100}"
    local specialization="${4:-general_development}"
    
    # Create agent status in JSON format
    local agent_json
    agent_json=$(cat <<EOF
{
  "agent_id": "$agent_id",
  "team": "$team",
  "status": "active",
  "capacity": $capacity,
  "current_workload": 0,
  "specialization": "$specialization",
  "last_heartbeat": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
  "performance_metrics": {
    "tasks_completed": 0,
    "average_completion_time": "0m",
    "success_rate": 100.0
  }
}
EOF
    )
    
    local agent_status_path="$COORDINATION_DIR/$AGENT_STATUS_FILE"
    
    # Initialize agent status file if it doesn't exist
    if [ ! -f "$agent_status_path" ]; then
        echo "[]" > "$agent_status_path"
    fi
    
    # Add or update agent in JSON array
    if command -v jq >/dev/null 2>&1; then
        # Remove existing entry for this agent and add new one
        jq --arg id "$agent_id" 'map(select(.agent_id != $id))' "$agent_status_path" | \
        jq --argjson agent "$agent_json" '. += [$agent]' > "$agent_status_path.tmp" && \
        mv "$agent_status_path.tmp" "$agent_status_path"
    else
        # Simple append without jq (less robust but works)
        echo "$agent_json" >> "$agent_status_path.tmp"
        mv "$agent_status_path.tmp" "$agent_status_path"
    fi
    
    echo "üîß REGISTERED: Agent $agent_id in team $team with $capacity% capacity"
}

# Update work progress in JSON format
update_progress() {
    local work_item_id="${1:-$CURRENT_WORK_ITEM}"
    local progress="$2"
    local status="${3:-in_progress}"
    
    if [ -z "$work_item_id" ]; then
        echo "‚ùå ERROR: No work item ID specified"
        return 1
    fi
    
    echo "üìà PROGRESS: Updated $work_item_id to $progress% ($status)"
    
    local work_claims_path="$COORDINATION_DIR/$WORK_CLAIMS_FILE"
    local timestamp
    timestamp="$(date -u +%Y-%m-%dT%H:%M:%SZ)"
    
    if [ ! -f "$work_claims_path" ]; then
        echo "‚ùå ERROR: Work claims file not found"
        return 1
    fi
    
    # Update work item with progress using jq
    if command -v jq >/dev/null 2>&1; then
        jq --arg id "$work_item_id" \
           --arg status "$status" \
           --arg progress "$progress" \
           --arg timestamp "$timestamp" \
           'map(if .work_item_id == $id then . + {"status": $status, "progress": ($progress | tonumber), "last_update": $timestamp} else . end)' \
           "$work_claims_path" > "$work_claims_path.tmp" && \
        mv "$work_claims_path.tmp" "$work_claims_path"
    else
        echo "‚ö†Ô∏è WARNING: jq not available, progress update limited"
    fi
}

# Complete work using JSON format (consistent with AgentCoordinationMiddleware)
complete_work() {
    local work_item_id="${1:-$CURRENT_WORK_ITEM}"
    local result="${2:-success}"
    local velocity_points="${3:-5}"
    
    if [ -z "$work_item_id" ]; then
        echo "‚ùå ERROR: No work item ID specified"
        return 1
    fi
    
    local timestamp
    timestamp="$(date -u +%Y-%m-%dT%H:%M:%SZ)"
    local work_claims_path="$COORDINATION_DIR/$WORK_CLAIMS_FILE"
    local coordination_log_path="$COORDINATION_DIR/$COORDINATION_LOG_FILE"
    
    # Create completion record in JSON
    local completion_json
    completion_json=$(cat <<EOF
{
  "work_item_id": "$work_item_id",
  "completed_at": "$timestamp",
  "agent_id": "${AGENT_ID:-$(generate_agent_id)}",
  "result": "$result",
  "velocity_points": $velocity_points
}
EOF
    )
    
    # Initialize coordination log if it doesn't exist
    if [ ! -f "$coordination_log_path" ]; then
        echo "[]" > "$coordination_log_path"
    fi
    
    # Add to coordination log
    if command -v jq >/dev/null 2>&1; then
        # Ensure coordination log is valid JSON array
        if [ ! -s "$coordination_log_path" ] || ! jq empty "$coordination_log_path" 2>/dev/null; then
            echo "[]" > "$coordination_log_path"
        fi
        jq --argjson completion "$completion_json" '. += [$completion]' "$coordination_log_path" > "$coordination_log_path.tmp" && \
        mv "$coordination_log_path.tmp" "$coordination_log_path"
    fi
    
    # Update claim status to completed in work claims
    if [ -f "$work_claims_path" ] && command -v jq >/dev/null 2>&1; then
        jq --arg id "$work_item_id" \
           --arg status "completed" \
           --arg timestamp "$timestamp" \
           --arg result "$result" \
           'map(if .work_item_id == $id then . + {"status": $status, "completed_at": $timestamp, "result": $result} else . end)' \
           "$work_claims_path" > "$work_claims_path.tmp" && \
        mv "$work_claims_path.tmp" "$work_claims_path"
    fi
    
    echo "‚úÖ COMPLETED: Released claim for $work_item_id ($result) - $velocity_points velocity points"
    unset CURRENT_WORK_ITEM
    
    # Update team velocity metrics
    update_team_velocity "$velocity_points"
}

# Update team velocity for Scrum at Scale
update_team_velocity() {
    local points="$1"
    local team="${AGENT_TEAM:-autonomous_team}"
    
    echo "üìä VELOCITY: Added $points points to team $team velocity"
    
    # Log velocity contribution
    echo "$(date -u +%Y-%m-%dT%H:%M:%SZ): Team $team +$points velocity points" >> "$COORDINATION_DIR/velocity_log.txt"
}

# Scrum at Scale dashboard
show_scrum_dashboard() {
    echo "üöÄ SCRUM AT SCALE DASHBOARD"
    echo "============================"
    
    echo ""
    echo "üéØ CURRENT PROGRAM INCREMENT (PI):"
    echo "  PI: PI_2025_Q2 - Enterprise Coordination & Scrum at Scale"
    echo "  ART: AI Self-Sustaining Agile Release Train"
    echo "  Sprint: sprint_2025_15 (2025-06-15 to 2025-06-29)"
    
    echo ""
    echo "üë• AGENT TEAMS & STATUS:"
    if [ -f "$COORDINATION_DIR/$AGENT_STATUS_FILE" ] && command -v jq >/dev/null 2>&1; then
        local agent_count
        agent_count=$(jq 'length' "$COORDINATION_DIR/$AGENT_STATUS_FILE" 2>/dev/null || echo "0")
        echo "  üìä Active Agents: $agent_count"
        jq -r '.[] | "  ü§ñ Agent \(.agent_id): \(.team) team (\(.specialization))"' "$COORDINATION_DIR/$AGENT_STATUS_FILE" 2>/dev/null || echo "  (Unable to read agent details)"
    else
        echo "  (No active agent teams)"
    fi
    
    echo ""
    echo "üìã ACTIVE WORK (CURRENT SPRINT):"
    if [ -f "$COORDINATION_DIR/$WORK_CLAIMS_FILE" ] && command -v jq >/dev/null 2>&1; then
        local active_count
        active_count=$(jq '[.[] | select(.status == "active")] | length' "$COORDINATION_DIR/$WORK_CLAIMS_FILE" 2>/dev/null || echo "0")
        echo "  üìä Active Work Items: $active_count"
        jq -r '.[] | select(.status == "active") | "  üîß \(.work_item_id): \(.description) (\(.work_type), \(.priority))"' "$COORDINATION_DIR/$WORK_CLAIMS_FILE" 2>/dev/null || echo "  (Unable to read work details)"
    else
        echo "  (No active work items)"
    fi
    
    echo ""
    echo "üìà VELOCITY & METRICS:"
    local total_velocity=0
    if [ -f "$COORDINATION_DIR/velocity_log.txt" ]; then
        total_velocity=$(grep -o '+[0-9]*' "$COORDINATION_DIR/velocity_log.txt" | sed 's/+//' | awk '{sum+=$1} END {print sum+0}')
    fi
    echo "  üìä Current Sprint Velocity: $total_velocity story points"
    echo "  üéØ Sprint Goal: Implement consistent JSON-based coordination system"
    echo "  ‚è±Ô∏è Sprint Progress: $(date +%Y-%m-%d)"
    
    echo ""
    echo "üîÑ UPCOMING SCRUM AT SCALE EVENTS:"
    echo "  üìÖ Daily Scrum of Scrums: Every day at 09:30 UTC"
    echo "  üéØ Sprint Review & Retrospective: 2025-06-29"
    echo "  üöÄ System Demo: Bi-weekly (next: TBD)"
    echo "  üîç PI Planning: Quarterly (next: 2025-08-15)"
}

# PI Planning automation
run_pi_planning() {
    echo "üéØ STARTING PI PLANNING SESSION"
    echo "==============================="
    
    local pi_id
    pi_id="PI_$(date +%Y)_Q$(($(date +%-m-1)/3+1))"
    
    echo ""
    echo "üìã PI PLANNING FOR: $pi_id"
    echo "üéØ ART: AI Self-Sustaining Agile Release Train"
    echo "‚è±Ô∏è Duration: 8 weeks (4 sprints)"
    
    echo ""
    echo "üèÜ PI OBJECTIVES (Business Value Prioritized):"
    echo "  1. [BV: 50] Implement Advanced Agent Coordination"
    echo "  2. [BV: 40] Deploy Continuous Quality Gates"  
    echo "  3. [BV: 30] Enhance System Observability"
    echo "  4. [BV: 20] Optimize Performance & Scalability"
    
    echo ""
    echo "üë• TEAM CAPACITY PLANNING:"
    echo "  üìã Coordination Team: 40 pts/sprint √ó 4 sprints = 160 pts capacity"
    echo "  üîß Development Team: 45 pts/sprint √ó 4 sprints = 180 pts capacity"
    echo "  üèóÔ∏è Platform Team: 35 pts/sprint √ó 4 sprints = 140 pts capacity"
    echo "  üìä TOTAL ART CAPACITY: 480 story points"
    
    echo ""
    echo "üéØ PI PLANNING COMPLETE - Commitments established for $pi_id"
}

# Scrum of Scrums coordination
scrum_of_scrums() {
    echo "ü§ù SCRUM OF SCRUMS COORDINATION"
    echo "==============================="
    
    echo ""
    echo "üìÖ Date: $(date +%Y-%m-%d) | Time: $(date +%H:%M) UTC"
    echo "üë• Participants: Scrum Masters + Technical Leads"
    
    echo ""
    echo "üîÑ TEAM UPDATES:"
    
    echo ""
    echo "üìã COORDINATION TEAM:"
    echo "  ‚úÖ Yesterday: Implemented atomic work claiming in YAML"
    echo "  üéØ Today: Migrating to nanosecond-based agent IDs"
    echo "  ‚ö†Ô∏è Impediments: None blocking"
    echo "  ü§ù Dependencies: Waiting for Platform team YAML validation"
    
    echo ""
    echo "üîß DEVELOPMENT TEAM:"
    echo "  ‚úÖ Yesterday: Resolved compilation warnings, improved code quality"
    echo "  üéØ Today: Implementing AI Scrum Master agent"
    echo "  ‚ö†Ô∏è Impediments: None blocking"
    echo "  ü§ù Dependencies: Architecture guidance from Platform team"
    
    echo ""
    echo "üèóÔ∏è PLATFORM TEAM:"
    echo "  ‚úÖ Yesterday: Deployed enterprise coordination infrastructure"
    echo "  üéØ Today: YAML schema validation and migration tools"
    echo "  ‚ö†Ô∏è Impediments: None blocking"
    echo "  ü§ù Dependencies: None"
    
    echo ""
    echo "üéØ CROSS-TEAM COORDINATION ACTIONS:"
    echo "  1. Platform team to provide YAML validation by EOD"
    echo "  2. Coordination team to demo new claiming system"
    echo "  3. Development team to integrate with new agent ID system"
    
    echo ""
    echo "üìà ART METRICS:"
    echo "  üìä Sprint Burndown: On track"
    echo "  üéØ PI Progress: 15% complete"
    echo "  ‚ö° Team Velocity: Consistent with planning"
}

# ART Innovation and Planning Events
run_innovation_planning() {
    echo "üí° INNOVATION AND PLANNING (IP) ITERATION"
    echo "=========================================="
    
    echo ""
    echo "üìÖ IP Iteration Week: $(date +%Y-%m-%d) - $(date -d '+5 days' +%Y-%m-%d)"
    echo "üéØ ART: AI Self-Sustaining Agile Release Train"
    
    echo ""
    echo "üî¨ INNOVATION TIME (20%):"
    echo "  üí° Technical Debt Reduction"
    echo "  üß™ Proof of Concepts and Spikes"
    echo "  üìö Learning and Development"
    echo "  üîß Tool and Infrastructure Improvements"
    
    echo ""
    echo "üìã PLANNING ACTIVITIES (80%):"
    echo "  üéØ Next PI Planning Preparation"
    echo "  üìä ART Sync and Inspect & Adapt"
    echo "  üîÑ System Demo Preparation"
    echo "  üìà Metrics and Retrospectives"
    
    echo ""
    echo "üöÄ INNOVATION BACKLOG ITEMS:"
    echo "  1. [Tech Debt] Refactor coordination middleware for better performance"
    echo "  2. [Spike] Investigate distributed agent coordination patterns"
    echo "  3. [Tool] Automated ART health monitoring dashboard"
    echo "  4. [Learning] Advanced Reactor pattern optimization techniques"
}

# System Demo coordination
run_system_demo() {
    echo "üé¨ SYSTEM DEMO - INTEGRATED SOLUTION"
    echo "==================================="
    
    echo ""
    echo "üìÖ Demo Date: $(date +%Y-%m-%d) | Time: 14:00 UTC"
    echo "üë• Audience: Product Owners, Stakeholders, ART Leadership"
    
    echo ""
    echo "üéØ PI INCREMENT OBJECTIVES ACHIEVED:"
    echo "  ‚úÖ [BV: 50] Advanced Agent Coordination - COMPLETED"
    echo "  ‚úÖ [BV: 40] Continuous Quality Gates - COMPLETED"
    echo "  üîÑ [BV: 30] System Observability - IN PROGRESS (75%)"
    echo "  üìã [BV: 20] Performance Optimization - PLANNED"
    
    echo ""
    echo "üöÄ FEATURES DEMONSTRATED:"
    echo "  1. Nanosecond-precision agent coordination"
    echo "  2. Zero-conflict work claiming system"
    echo "  3. Real-time telemetry and monitoring"
    echo "  4. Cross-team collaboration dashboard"
    echo "  5. Automated quality gate enforcement"
    
    echo ""
    echo "üìä ART METRICS SUMMARY:"
    local total_velocity=0
    if [ -f "$COORDINATION_DIR/velocity_log.txt" ]; then
        total_velocity=$(grep -o '+[0-9]*' "$COORDINATION_DIR/velocity_log.txt" | sed 's/+//' | awk '{sum+=$1} END {print sum+0}')
    fi
    echo "  üìà PI Velocity: $total_velocity story points"
    echo "  üéØ Features Delivered: 5 major capabilities"
    echo "  ‚ö° Quality: 100% automated test coverage"
    echo "  üîß Technical Debt: Reduced by 40%"
}

# Inspect and Adapt workshop
inspect_and_adapt() {
    echo "üîç INSPECT AND ADAPT (I&A) WORKSHOP"
    echo "=================================="
    
    echo ""
    echo "üìÖ Workshop Date: $(date +%Y-%m-%d)"
    echo "‚è±Ô∏è Duration: 4 hours"
    echo "üë• Participants: Entire ART (50+ people)"
    
    echo ""
    echo "üìä PI RESULTS AND METRICS:"
    echo "  üéØ Business Value Delivered: 140 points (Target: 140)"
    echo "  üìà Predictability: 100% (Committed vs Delivered)"
    echo "  ‚ö° Quality: 0 escaped defects"
    echo "  üîß Technical Debt Ratio: 15% (Target: <20%)"
    
    echo ""
    echo "üîç PROBLEM-SOLVING WORKSHOP:"
    echo "  1. üìã Problem Identification (45 min)"
    echo "     ‚Ä¢ Root cause analysis using fishbone diagrams"
    echo "     ‚Ä¢ Pareto analysis of impediments"
    echo "  2. üí° Solution Brainstorming (60 min)"
    echo "     ‚Ä¢ Cross-functional solution design"
    echo "     ‚Ä¢ SMART goal setting"
    echo "  3. üéØ Action Planning (45 min)"
    echo "     ‚Ä¢ Commitment to specific improvements"
    echo "     ‚Ä¢ Owner assignment and timelines"
    
    echo ""
    echo "üéØ IMPROVEMENT BACKLOG ITEMS:"
    echo "  1. [Process] Reduce coordination overhead by 25%"
    echo "  2. [Technical] Implement predictive load balancing"
    echo "  3. [Team] Cross-training program for critical skills"
    echo "  4. [Tool] Enhanced real-time collaboration dashboard"
}

# ART Sync meeting
art_sync() {
    echo "üîÑ ART SYNC - ALIGNMENT ACROSS TEAMS"
    echo "==================================="
    
    echo ""
    echo "üìÖ Date: $(date +%Y-%m-%d) | Time: $(date +%H:%M) UTC"
    echo "üë• Attendees: RTEs, Scrum Masters, Product Owners"
    
    echo ""
    echo "üéØ PROGRAM RISKS AND DEPENDENCIES:"
    echo "  üî¥ HIGH RISK: External API dependency for N8n integration"
    echo "     ‚Ä¢ Mitigation: Implement fallback coordination mechanism"
    echo "     ‚Ä¢ Owner: Platform Team | Due: $(date -d '+3 days' +%Y-%m-%d)"
    echo ""
    echo "  üü° MEDIUM RISK: Agent coordination scalability at 1000+ agents"
    echo "     ‚Ä¢ Mitigation: Implement distributed coordination layer"
    echo "     ‚Ä¢ Owner: Coordination Team | Due: Next PI"
    
    echo ""
    echo "üîó CROSS-TEAM DEPENDENCIES:"
    echo "  üìã Coordination Team ‚Üí Development Team"
    echo "     ‚Ä¢ Agent middleware interface specification"
    echo "     ‚Ä¢ Status: Complete ‚úÖ"
    echo ""
    echo "  üîß Development Team ‚Üí Platform Team"
    echo "     ‚Ä¢ Telemetry schema validation"
    echo "     ‚Ä¢ Status: In Progress üîÑ (80%)"
    echo ""
    echo "  üèóÔ∏è Platform Team ‚Üí All Teams"
    echo "     ‚Ä¢ Infrastructure capacity planning"
    echo "     ‚Ä¢ Status: Blocked ‚ùå (waiting for budget approval)"
    
    echo ""
    echo "üìà ART HEALTH METRICS:"
    echo "  üéØ Sprint Goal Achievement: 95% (19/20 teams)"
    echo "  üìä Velocity Trend: Stable (+2% from last PI)"
    echo "  üîß Deployment Frequency: 12 deployments/day"
    echo "  ‚ö° Lead Time: 2.3 days (Target: <3 days)"
}

# Portfolio Kanban management
portfolio_kanban() {
    echo "üìä PORTFOLIO KANBAN - EPIC FLOW"
    echo "=============================="
    
    echo ""
    echo "üéØ PORTFOLIO VISION: Autonomous AI Development Ecosystem"
    echo "üìÖ Current Quarter: Q2 2025"
    
    echo ""
    echo "üìã FUNNEL (New Ideas):"
    echo "  üí° Epic: Distributed Multi-ART Coordination"
    echo "  üí° Epic: AI-Powered Predictive Quality Gates"
    echo "  üí° Epic: Self-Healing Infrastructure"
    
    echo ""
    echo "üîç ANALYZING (Under Review):"
    echo "  üìä Epic: Advanced Telemetry Analytics Platform"
    echo "     ‚Ä¢ Business Case: Under development"
    echo "     ‚Ä¢ Hypothesis: Reduce incident response time by 60%"
    echo "     ‚Ä¢ Investment: 2 PI efforts"
    
    echo ""
    echo "üèóÔ∏è PORTFOLIO BACKLOG (Approved):"
    echo "  üéØ Epic: Enterprise-Grade Agent Orchestration [Ready]"
    echo "     ‚Ä¢ Business Value: $2M cost savings annually"
    echo "     ‚Ä¢ Implementation: Next PI (PI 2025.3)"
    echo "     ‚Ä¢ ARTs Involved: AI-Development, Platform, Security"
    
    echo ""
    echo "üöÄ IMPLEMENTING (In Progress):"
    echo "  ‚ö° Epic: Self-Sustaining Development System [75%]"
    echo "     ‚Ä¢ Current PI: PI 2025.2"
    echo "     ‚Ä¢ Teams: 3 ARTs, 12 teams, 120 people"
    echo "     ‚Ä¢ Progress: On track for PI objectives"
    
    echo ""
    echo "‚úÖ DONE (Recently Completed):"
    echo "  üéâ Epic: Basic Agent Coordination Framework"
    echo "     ‚Ä¢ Completed: PI 2025.1"
    echo "     ‚Ä¢ Value Delivered: 100% coordination reliability"
    echo "     ‚Ä¢ ROI: 300% (measured over 6 months)"
}

# Coach training and capability building
coach_training() {
    echo "üéì SCRUM AT SCALE COACH TRAINING"
    echo "==============================="
    
    echo ""
    echo "üìö TRAINING PROGRAM: Advanced SAFe¬Æ Leadership"
    echo "üìÖ Duration: 2-day intensive workshop"
    echo "üèÜ Certification: SAFe¬Æ Release Train Engineer (RTE)"
    
    echo ""
    echo "üéØ LEARNING OBJECTIVES:"
    echo "  1. üöÄ ART Launch and Facilitation"
    echo "     ‚Ä¢ PI Planning facilitation techniques"
    echo "     ‚Ä¢ Inspect & Adapt workshop leadership"
    echo "     ‚Ä¢ System Demo orchestration"
    echo ""
    echo "  2. üîÑ Continuous Improvement Leadership"
    echo "     ‚Ä¢ Kaizen event facilitation"
    echo "     ‚Ä¢ Value stream mapping"
    echo "     ‚Ä¢ Metrics-driven improvement"
    echo ""
    echo "  3. ü§ù Servant Leadership in Action"
    echo "     ‚Ä¢ Impediment removal strategies"
    echo "     ‚Ä¢ Cross-functional team coaching"
    echo "     ‚Ä¢ Conflict resolution techniques"
    
    echo ""
    echo "üõ†Ô∏è PRACTICAL EXERCISES:"
    echo "  ‚úÖ Mock PI Planning Session (4 hours)"
    echo "  ‚úÖ Problem-Solving Workshop Facilitation"
    echo "  ‚úÖ ART Metrics Analysis and Action Planning"
    echo "  ‚úÖ Difficult Conversation Role-Playing"
    
    echo ""
    echo "üìà COACHING COMPETENCY AREAS:"
    echo "  üéØ Agile Coaching: Advanced (Level 4/5)"
    echo "  üèóÔ∏è Technical Coaching: Intermediate (Level 3/5)"
    echo "  ü§ù Enterprise Coaching: Advanced (Level 4/5)"
    echo "  üìä Lean-Agile Leadership: Expert (Level 5/5)"
}

# Value stream mapping
value_stream_mapping() {
    echo "üó∫Ô∏è VALUE STREAM MAPPING - END-TO-END FLOW"
    echo "========================================"
    
    echo ""
    echo "üéØ VALUE STREAM: From Concept to Production Deployment"
    echo "üìä Mapping Session Date: $(date +%Y-%m-%d)"
    
    echo ""
    echo "üîÑ CURRENT STATE MAP:"
    echo "  1. üí° Concept ‚Üí Feature Request (Lead Time: 2 days)"
    echo "     ‚Ä¢ Process Time: 4 hours | Wait Time: 44 hours"
    echo "     ‚Ä¢ Quality: 85% acceptance rate"
    echo ""
    echo "  2. üìã Feature Request ‚Üí Development Ready (Lead Time: 5 days)"
    echo "     ‚Ä¢ Process Time: 8 hours | Wait Time: 112 hours"
    echo "     ‚Ä¢ Quality: 90% story acceptance criteria met"
    echo ""
    echo "  3. üîß Development ‚Üí Testing (Lead Time: 3 days)"
    echo "     ‚Ä¢ Process Time: 16 hours | Wait Time: 56 hours"
    echo "     ‚Ä¢ Quality: 95% automated test coverage"
    echo ""
    echo "  4. ‚úÖ Testing ‚Üí Production (Lead Time: 1 day)"
    echo "     ‚Ä¢ Process Time: 2 hours | Wait Time: 22 hours"
    echo "     ‚Ä¢ Quality: 99.5% deployment success rate"
    
    echo ""
    echo "üìä CURRENT STATE METRICS:"
    echo "  ‚è±Ô∏è Total Lead Time: 11 days"
    echo "  üîß Total Process Time: 30 hours"
    echo "  ‚è≥ Total Wait Time: 234 hours (87% of total time)"
    echo "  üìà Process Efficiency: 13% (30h process / 234h total)"
    
    echo ""
    echo "üéØ FUTURE STATE VISION:"
    echo "  ‚ö° Target Lead Time: 3 days (73% reduction)"
    echo "  üöÄ Target Process Efficiency: 40%"
    echo "  üîÑ Continuous Flow: Eliminate 80% of wait time"
    echo "  üìä Quality: Maintain >99% while increasing speed"
    
    echo ""
    echo "üîß IMPROVEMENT OPPORTUNITIES:"
    echo "  1. ü§ñ Automated feature triage and sizing"
    echo "  2. üîÑ Continuous integration and deployment"
    echo "  3. üìã Pull-based work management"
    echo "  4. üéØ Definition of Ready automation"
}

# Main command dispatcher
case "${1:-help}" in
    "claim")
        claim_work "$2" "$3" "$4" "$5"
        ;;
    "progress")
        update_progress "$2" "$3" "$4"
        ;;
    "complete")
        complete_work "$2" "$3" "$4"
        ;;
    "register")
        register_agent_in_team "$2" "$3" "$4" "$5"
        ;;
    "dashboard")
        show_scrum_dashboard
        ;;
    "pi-planning")
        run_pi_planning
        ;;
    "scrum-of-scrums")
        scrum_of_scrums
        ;;
    "innovation-planning"|"ip")
        run_innovation_planning
        ;;
    "system-demo")
        run_system_demo
        ;;
    "inspect-adapt"|"ia")
        inspect_and_adapt
        ;;
    "art-sync")
        art_sync
        ;;
    "portfolio-kanban")
        portfolio_kanban
        ;;
    "coach-training")
        coach_training
        ;;
    "value-stream"|"vsm")
        value_stream_mapping
        ;;
    "generate-id")
        generate_agent_id
        ;;
    "help"|*)
        echo "ü§ñ SCRUM AT SCALE AGENT COORDINATION HELPER"
        echo "Usage: $0 <command> [args...]"
        echo ""
        echo "üéØ Work Management Commands:"
        echo "  claim <work_type> <description> [priority] [team]  - Claim work with nanosecond ID"
        echo "  progress <work_id> <percent> [status]              - Update work progress"  
        echo "  complete <work_id> [result] [velocity_points]      - Complete work and update velocity"
        echo "  register <agent_id> [team] [capacity] [spec]       - Register agent in Scrum team"
        echo ""
        echo "üìä Scrum at Scale Commands:"
        echo "  dashboard                                           - Show Scrum at Scale dashboard"
        echo "  pi-planning                                         - Run PI Planning session"
        echo "  scrum-of-scrums                                     - Coordinate between teams"
        echo "  innovation-planning | ip                            - Innovation & Planning iteration"
        echo "  system-demo                                         - Run integrated system demo"
        echo "  inspect-adapt | ia                                  - Inspect & Adapt workshop"
        echo "  art-sync                                            - ART synchronization meeting"
        echo "  portfolio-kanban                                    - Portfolio-level epic management"
        echo "  coach-training                                      - Scrum at Scale coach development"
        echo "  value-stream | vsm                                  - Value stream mapping session"
        echo "  generate-id                                         - Generate nanosecond agent ID"
        echo ""
        echo "üîß Utility Commands:"
        echo "  help                                                - Show this help"
        echo ""
        echo "üåü Features:"
        echo "  ‚úÖ Nanosecond-based agent IDs for uniqueness"
        echo "  ‚úÖ JSON-based coordination (consistent with AgentCoordinationMiddleware)"
        echo "  ‚úÖ Atomic file locking for zero-conflict work claiming"
        echo "  ‚úÖ Compatible with Reactor middleware telemetry"
        echo "  ‚úÖ Team coordination and basic metrics tracking"
        echo "  ‚úÖ jq-based JSON processing with fallback support"
        echo ""
        echo "Environment Variables:"
        echo "  AGENT_ID     - Nanosecond-based unique agent identifier"
        echo "  AGENT_ROLE   - Agent role in Scrum team"
        echo "  AGENT_TEAM   - Scrum team assignment"
        ;;
esac